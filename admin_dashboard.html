<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理者ダッシュボード（アラート一括管理）</title>
    <link rel="manifest" href="/manifest.json">
    <script src="js/auth_check.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', 'Meiryo', sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f6fa;
        }
        
        .header {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.8rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        
        .card h3 {
            margin: 0 0 1rem 0;
            color: #2c3e50;
            font-size: 1.3rem;
        }
        
        .card-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .stat-item {
            text-align: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #e74c3c;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 0.5rem;
        }
        
        .action-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
            margin-top: 1rem;
        }
        
        .action-btn:hover {
            background: #2980b9;
        }
        
        .action-btn.danger {
            background: #e74c3c;
        }
        
        .action-btn.danger:hover {
            background: #c0392b;
        }
        
        .action-btn.success {
            background: #27ae60;
        }
        
        .action-btn.success:hover {
            background: #229954;
        }
        
        .recent-activity {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid #eee;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            font-size: 1.5rem;
            margin-right: 1rem;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-time {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .alert-banner {
            background: #e74c3c;
            color: white;
            padding: 1em;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
        }
        
        th, td {
            border: 1px solid #eee;
            padding: 0.7em;
            text-align: center;
        }
        
        th {
            background: #3498db;
            color: white;
        }
        
        .status-unread {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .status-read {
            color: #27ae60;
        }
        
        .btn {
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 0.5em 1.2em;
            cursor: pointer;
        }
        
        .btn:disabled {
            background: #aaa;
        }
        
        @media (max-width: 700px) {
            .container {
                padding: 0.5em;
            }
            th, td {
                font-size: 0.9em;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>👑 管理者ダッシュボード（アラート一括管理）</h1>
        <div class="user-info">
            <span id="userDisplay"></span>
            <button class="logout-btn" onclick="logout()">🚪 ログアウト</button>
        </div>
    </div>
    
    <div class="container">
        <div class="alert-banner" id="alertBanner"></div>
        <div class="dashboard-grid">
            <div class="card">
                <div class="card-icon">👥</div>
                <h3>ユーザー管理</h3>
                <p>登録ユーザーの管理、権限設定、アカウントロック解除を行います。</p>
        <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="totalUsers">0</div>
                        <div class="stat-label">総ユーザー数</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="activeUsers">0</div>
                        <div class="stat-label">アクティブ</div>
                    </div>
                </div>
                <button class="action-btn" onclick="manageUsers()">ユーザー管理</button>
            </div>
            
            <div class="card">
                <div class="card-icon">📊</div>
                <h3>利用統計</h3>
                <p>システムの利用状況、ゲームプレイ統計、パフォーマンス分析を確認します。</p>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="todaySessions">0</div>
                        <div class="stat-label">今日のセッション</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="avgSessionTime">0</div>
                        <div class="stat-label">平均セッション時間</div>
                    </div>
                </div>
                <button class="action-btn success" onclick="viewReports()">レポート表示</button>
            </div>
            
            <div class="card">
                <div class="card-icon">⚙️</div>
                <h3>システム設定</h3>
                <p>システムパラメータ、セキュリティ設定、バックアップ設定を管理します。</p>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="systemStatus">正常</div>
                        <div class="stat-label">システム状態</div>
            </div>
                    <div class="stat-item">
                        <div class="stat-number" id="lastBackup">-</div>
                        <div class="stat-label">最終バックアップ</div>
            </div>
        </div>
                <button class="action-btn" onclick="systemSettings()">設定変更</button>
                <button class="action-btn danger" onclick="backupData()">バックアップ</button>
            </div>
        </div>
        
        <div class="recent-activity">
            <h3>📋 最近のアクティビティ</h3>
            <div id="activityList">
                <div class="activity-item">
                    <div class="activity-icon">🔐</div>
                    <div class="activity-content">
                        <div>管理者ダッシュボードにアクセス</div>
                        <div class="activity-time" id="currentTime"></div>
                </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>アラート一覧</h2>
        <table>
            <thead>
                <tr>
                    <th>時刻</th><th>現場名</th><th>内容</th><th>重要度</th><th>状態</th><th>操作</th>
                </tr>
            </thead>
            <tbody id="alertTableBody">
                <!-- アラート行がここに挿入されます -->
            </tbody>
        </table>
    </div>

    <script>
        // 管理者権限チェック
        if (!isManager()) {
            alert('このページにアクセスするには管理者権限が必要です。');
            window.location.href = 'index.html';
        }
        
        // ユーザー情報表示
        function displayUserInfo() {
            const userData = localStorage.getItem('registeredUser');
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    document.getElementById('userDisplay').textContent = 
                        `👑 管理者 ${user.lastName} ${user.firstName}`;
                } catch (error) {
                    console.error('ユーザー情報の解析に失敗:', error);
                }
            }
        }
        
        // 統計データの初期化
        function initializeStats() {
            // サンプルデータ（実際の実装ではAPIから取得）
            document.getElementById('totalUsers').textContent = '12';
            document.getElementById('activeUsers').textContent = '8';
            document.getElementById('todaySessions').textContent = '45';
            document.getElementById('avgSessionTime').textContent = '25分';
            document.getElementById('systemStatus').textContent = '正常';
            document.getElementById('lastBackup').textContent = '今日';
            
            // 現在時刻表示
            document.getElementById('currentTime').textContent = 
                new Date().toLocaleString('ja-JP');
        }
        
        // 管理者機能
        function manageUsers() {
            alert('ユーザー管理機能は開発中です');
        }
        
        function viewReports() {
            alert('レポート表示機能は開発中です');
        }
        
        function systemSettings() {
            alert('システム設定機能は開発中です');
        }
        
        function backupData() {
            alert('データバックアップ機能は開発中です');
        }
        
        function logout() {
            if (confirm('ログアウトしますか？')) {
                localStorage.removeItem('isAuthenticated');
                localStorage.removeItem('lastLoginTime');
                window.location.href = 'pin_login.html';
            }
        }
        
        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', function() {
            displayUserInfo();
            initializeStats();
        });

        // 疑似アラートデータ（API連携部分は後で実装）
        let alerts = [
            { id: 1, time: '2024-06-20 10:12', site: '現場A', message: 'サーバー応答なし', level: '高', status: '未対応' },
            { id: 2, time: '2024-06-20 10:15', site: '現場B', message: 'ディスク容量90%超過', level: '中', status: '未対応' },
            { id: 3, time: '2024-06-20 10:20', site: '現場C', message: 'ネットワーク断', level: '高', status: '未対応' }
        ];
        function renderAlerts() {
            const tbody = document.getElementById('alertTableBody');
            tbody.innerHTML = '';
            alerts.forEach(alert => {
                tbody.innerHTML += `<tr>
                    <td>${alert.time}</td>
                    <td>${alert.site}</td>
                    <td>${alert.message}</td>
                    <td>${alert.level}</td>
                    <td class="${alert.status==='未対応'?'status-unread':'status-read'}">${alert.status}</td>
                    <td><button class="btn" onclick="markAsRead(${alert.id})" ${alert.status==='対応済み'?'disabled':''}>対応済みに</button></td>
                </tr>`;
            });
        }
        function markAsRead(id) {
            alerts = alerts.map(a => a.id===id ? { ...a, status: '対応済み' } : a);
            renderAlerts();
        }
        // 新着アラートバナー通知（サンプル）
        function showBanner(msg) {
            const banner = document.getElementById('alertBanner');
            banner.textContent = msg;
            banner.style.display = 'block';
            setTimeout(()=>{ banner.style.display = 'none'; }, 5000);
        }
        // 疑似的に新着アラートを追加
        setTimeout(()=>{
            alerts.unshift({ id: 4, time: '2024-06-20 10:30', site: '現場D', message: 'CPU使用率90%超', level: '高', status: '未対応' });
            renderAlerts();
            showBanner('新しいアラート: 現場D CPU使用率90%超');
            // ブラウザ通知
            if (Notification && Notification.permission === 'granted') {
                new Notification('新着アラート', { body: '現場D CPU使用率90%超' });
            }
        }, 7000);
        // PWA用 通知許可リクエスト
        if (Notification && Notification.permission !== 'granted') {
            Notification.requestPermission();
        }
        renderAlerts();
    </script>
</body>
</html> 